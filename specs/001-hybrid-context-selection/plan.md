# Implementation Plan: Hybrid Context Selection

**Branch**: `001-hybrid-context-selection` | **Date**: January 19, 2026 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-hybrid-context-selection/spec.md`

---

## Summary

Replace the LLM-based file selection (`selectContext()`) with a local, deterministic function that uses core bundle patterns, keyword matching, recently-edited boosts, and grep fallback. This eliminates one LLM call per user message, reducing tokens by ~50% and selection latency from 2-5 seconds to <100ms.

---

## Technical Context

**Language/Version**: TypeScript 5.7.2 (strict mode)
**Primary Dependencies**: ai (Vercel AI SDK), nanostores, ignore
**Storage**: N/A (in-memory only)
**Testing**: Vitest
**Target Platform**: Cloudflare Pages (edge functions)
**Project Type**: Web application (Remix)
**Performance Goals**: <100ms context selection latency
**Constraints**: 30s edge function timeout, no external services for selection
**Scale/Scope**: 20-30 files per restaurant website

---

## Constitution Check

*The project constitution is a template. Using reasonable defaults:*

| Principle | Status | Notes |
|-----------|--------|-------|
| Code Quality | ✅ Pass | TypeScript strict mode, Zod validation where applicable |
| Testing | ✅ Pass | Unit tests for getContextFiles, integration test for selectContext |
| Simplicity | ✅ Pass | No external dependencies, simple scoring algorithm |

---

## Project Structure

### Documentation (this feature)

```text
specs/001-hybrid-context-selection/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity definitions
├── quickstart.md        # Implementation guide
├── contracts/           # Interface definitions
│   └── interfaces.md    # TypeScript interfaces
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
app/lib/.server/llm/
├── context/                      # NEW DIRECTORY
│   ├── index.ts                  # Re-exports
│   ├── getContextFiles.ts        # Core selection function
│   ├── patterns.ts               # CORE_PATTERNS, KEYWORD_MAP
│   ├── grep.ts                   # grepForSpecificText
│   └── types.ts                  # ContextOptions, ScoredFile
├── select-context.ts             # MODIFIED - use local function
├── constants.ts                  # UNCHANGED
├── create-summary.ts             # UNCHANGED
└── stream-text.ts                # UNCHANGED

app/routes/
└── api.chat.ts                   # MINOR CHANGE - pass recentlyEdited

app/lib/stores/
└── files.ts                      # MINOR CHANGE - expose modified file paths
```

**Structure Decision**: Single web application with server-side LLM integration. New code goes in `app/lib/.server/llm/context/` directory following existing patterns.

---

## Implementation Phases

### Phase 1: Core Selection Function (P1)

Create the core `getContextFiles()` function with scoring algorithm.

**Tasks**:
1. Create `app/lib/.server/llm/context/types.ts` with ContextOptions, ScoredFile, BoostWeights
2. Create `app/lib/.server/llm/context/patterns.ts` with CORE_PATTERNS and KEYWORD_MAP
3. Create `app/lib/.server/llm/context/getContextFiles.ts` with main function
4. Create `app/lib/.server/llm/context/index.ts` re-exporting all
5. Write unit tests for getContextFiles

**Acceptance**:
- Function returns correct files for "change header color" query
- Core bundle files always included
- Keyword matching works for all defined keywords
- Returns sorted by score, limited to maxFiles

---

### Phase 2: Grep Fallback (P3)

Add grep functionality for specific text searches.

**Tasks**:
1. Create `app/lib/.server/llm/context/grep.ts` with grepForSpecificText
2. Implement pattern extraction (quotes, prices, hex colors)
3. Implement file content search
4. Write unit tests for grep function

**Acceptance**:
- Finds files containing "$14" when user says 'change "$14" to "$16"'
- Finds files containing hex colors
- Returns unique file paths

---

### Phase 3: Recently Edited Boost (P2)

Add tracking and boosting for recently edited files.

**Tasks**:
1. Add `getModifiedFilePaths()` method to FilesStore
2. Update getContextFiles to apply +8 boost for recently edited files
3. Write unit tests for boost behavior

**Acceptance**:
- Recently edited files appear higher in results
- Boost correctly applied (+8)
- Works with empty recentlyEdited array

---

### Phase 4: Chat Mention Boost (P3)

Add boosting for files mentioned in chat history.

**Tasks**:
1. Add chat mention detection to getContextFiles
2. Apply +3 boost for mentioned files
3. Write unit tests

**Acceptance**:
- Files mentioned by name in chat get +3 boost
- Works with component names (Hero, Menu, Footer)

---

### Phase 5: Integration (P1)

Replace LLM call in selectContext with local function.

**Tasks**:
1. Modify selectContext to import and use getContextFiles
2. Remove LLM generateText call
3. Remove XML parsing logic
4. Add recentlyEdited parameter to function signature
5. Update api.chat.ts to pass recentlyEdited (optional)
6. Write integration tests

**Acceptance**:
- selectContext returns FileMap without LLM call
- Latency <100ms
- Existing API interface preserved
- All existing tests pass

---

### Phase 6: Testing & Validation

Comprehensive testing against sample queries.

**Tasks**:
1. Create test dataset of 20 queries with expected files
2. Run accuracy comparison (old vs new)
3. Measure latency improvement
4. Edge case testing
5. Fix any issues

**Acceptance**:
- >90% accuracy on test dataset
- <100ms latency confirmed
- All edge cases handled

---

## Complexity Tracking

No constitution violations. Implementation is straightforward:
- No new external dependencies
- No database changes
- No new API endpoints
- Simple additive scoring (no ML/embeddings)

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Keyword map incomplete | Medium | Medium | Log missed keywords; easy to extend |
| Performance regression | Low | High | Benchmark; no network calls |
| Breaking existing tests | Low | Medium | Preserve interface; run full test suite |

---

## Dependencies

**No new npm packages required.**

Uses existing:
- `ai` package (Message types)
- `ignore` package (pattern matching)
- `nanostores` (state management)

---

## Generated Artifacts

| Artifact | Path | Status |
|----------|------|--------|
| Research | `specs/001-hybrid-context-selection/research.md` | ✅ Complete |
| Data Model | `specs/001-hybrid-context-selection/data-model.md` | ✅ Complete |
| Contracts | `specs/001-hybrid-context-selection/contracts/interfaces.md` | ✅ Complete |
| Quickstart | `specs/001-hybrid-context-selection/quickstart.md` | ✅ Complete |
| Tasks | `specs/001-hybrid-context-selection/tasks.md` | ⏳ Pending /speckit.tasks |

---

## Next Steps

Run `/speckit.tasks` to generate the detailed task breakdown with dependencies and implementation order.
